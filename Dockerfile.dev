# Dockerfile.dev
# v0.7.7-rc1 (custom for XOR-ChatNexus dev with hot reload)

# Base node image
FROM node:20-alpine AS base

# Install curl, bash, and build tools for sharp (libvips, python, make, g++)
RUN apk --no-cache add curl bash build-base python3 make g++ vips-dev

# Set working directory
WORKDIR /app

# Copy package.json and package-lock.json from root and workspaces
COPY package.json package-lock.json ./
COPY api/package.json api/
COPY client/package.json client/
COPY packages/data-provider/package.json packages/data-provider/
COPY packages/mcp/package.json packages/mcp/

# Install all dependencies (including dev dependencies)
RUN npm config set fetch-retry-maxtimeout 600000 && \
    npm config set fetch-retries 5 && \
    npm config set fetch-retry-mintimeout 15000 && \
    npm ci

# Copy all source code
COPY . .

# Create directories for volumes with correct permissions
RUN mkdir -p /app/client/public/images /app/api/logs && \
    chown node:node /app /app/client /app/api /app/client/public/images /app/api/logs

# Use node user for security
USER node

# Expose ports for backend (3080) and frontend (5173)
EXPOSE 3080 5173

# Run both backend and frontend in dev mode with hot reload
CMD ["sh", "-c", "cd /app/api && npm run backend:dev & cd /app/client && npm run dev"]